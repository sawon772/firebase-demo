<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pro Messenger - Professional Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #f5f7fa; /* Lighter background */
            --card: #fff;
            --text: #1a202c; /* Darker text */
            --muted: #718096;
            --accent: #0b84ff;
            --accent-hover: #0066cc;
            --border: #edf2f7;
            --hover: rgba(0,0,0,0.05);
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --radius: 16px; /* Slightly larger radius for modern look */
            --radius-sm: 8px;
            --header-height: 64px;
        }

        body.dark {
            --bg: #121212;
            --card: #1e1e1e;
            --text: #e2e8f0;
            --muted: #a0aec0;
            --accent: #4299e1;
            --accent-hover: #3182ce;
            --border: #2d3748;
            --hover: rgba(255,255,255,0.08);
            --shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        * {
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        body {
            margin: 0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            height: 100vh;
            overflow: hidden;
            display: flex; /* For full screen app */
        }

        .container {
            max-width: 1400px; /* Wider container */
            width: 100%;
            margin: 0 auto;
            display: flex;
            height: 100vh;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: 0 0 0 1px var(--border), var(--shadow); /* Subtle app shadow */
        }

        /* Left Panel - Chat List */
        .left-panel {
            min-width: 320px;
            max-width: 400px;
            width: 30%;
            background: var(--card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            z-index: 10;
        }

        .header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--card);
            z-index: 1;
            min-height: var(--header-height);
        }

        .profile-mini {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .profile-mini img {
            width: 40px; /* Slightly smaller for professional look */
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent);
            flex-shrink: 0;
        }

        .profile-info h3 {
            margin: 0;
            font-size: 15px;
            font-weight: 600;
        }

        .profile-info p {
            margin: 2px 0 0;
            font-size: 12px;
            color: var(--muted);
        }

        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s, transform 0.1s;
        }

        .btn:hover {
            background: var(--accent-hover);
        }
        
        .btn:active {
            transform: scale(0.99);
        }

        .btn-icon {
            padding: 10px;
            width: 40px;
            height: 40px;
            background: transparent;
            border: none;
            border-radius: 50%; /* Icon buttons are typically round */
            cursor: pointer;
            color: var(--muted);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, color 0.2s;
        }

        .btn-icon:hover {
            background: var(--hover);
            color: var(--text);
        }

        .search-box {
            padding: 0 20px 16px; /* Adjust padding */
            border-bottom: 1px solid var(--border);
        }

        .search-container input {
            padding: 10px 12px 10px 40px;
            border-radius: 24px; /* Pill shape */
            border: 1px solid var(--border);
            background: var(--bg);
            font-size: 14px;
        }

        .new-chat-btn {
            padding: 16px 20px 0;
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px 8px; /* Consistent inner padding */
        }

        .chat-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

        .chat-item:hover:not(.active) {
            background: var(--hover);
        }

        .chat-item.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 2px 8px rgba(11, 132, 255, 0.3); /* Accent shadow for active */
        }
        
        .chat-item.active .chat-name,
        .chat-item.active .last-message,
        .chat-item.active .time {
            color: white;
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }
        
        .unread-badge {
            background: #ff4d6d;
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            /* ... existing styles ... */
        }

        /* Right Panel - Chat Window */
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg);
            position: relative;
        }

        .chat-window {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header-main {
            padding: 12px 24px;
            border-bottom: 1px solid var(--border);
            background: var(--card);
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: var(--header-height);
        }
        
        .messages-container {
            /* ... existing styles ... */
        }

        .message.sent {
            background: var(--accent);
            color: white;
            /* ... existing styles ... */
        }

        .message.received {
            background: var(--card);
            border: 1px solid var(--border);
            /* ... existing styles ... */
        }

        .message-composer {
            padding: 12px 24px;
            background: var(--card);
            border-top: 1px solid var(--border);
            flex-shrink: 0; /* Ensure it doesn't get squeezed */
        }
        
        .composer-container input {
            padding: 10px 16px; /* Reduced vertical padding */
            border-radius: 24px;
            background: var(--bg);
            border: 1px solid var(--border);
        }
        
        /* Mobile Responsive Improvements */
        @media (max-width: 800px) { /* Use a slightly wider breakpoint for a better experience */
            .container {
                box-shadow: none; /* Remove shadow on mobile */
                border-radius: 0;
            }

            .left-panel {
                width: 100%;
                max-width: 100%;
                position: absolute;
                height: 100%;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                border-right: none;
            }

            .left-panel.active {
                transform: translateX(0);
                box-shadow: var(--shadow); /* Shadow when open */
            }

            .right-panel {
                width: 100%;
            }

            .message {
                max-width: 90%;
            }

            .mobile-menu-btn {
                display: flex;
                position: absolute; /* Place on top of right panel */
                left: 10px;
                top: 10px;
                z-index: 5;
            }
            
            .back-to-chats {
                display: flex !important;
            }
            
            .chat-header-main {
                padding-left: 10px; /* Adjust for back button */
            }
        }

        @media (min-width: 801px) {
            .left-panel {
                width: 380px; /* Fixed width on desktop */
            }
            .mobile-menu-btn,
            .back-to-chats {
                display: none !important;
            }
        }

        /* ... all other existing CSS ... */
    </style>
</head>
<body>
    <div class="modal" id="loginModal" style="display: flex;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Welcome to Pro Messenger</h3>
            </div>
            <div class="login-card" style="box-shadow: none; padding: 0;">
                <form id="loginForm">
                    <div class="form-group">
                        <label>Country</label>
                        <select id="countrySelect">
                            <option value="+880">Bangladesh (+880)</option>
                            <option value="+91">India (+91)</option>
                            <option value="+62">Indonesia (+62)</option>
                            <option value="+60">Malaysia (+60)</option>
                            <option value="+977">Nepal (+977)</option>
                            <option value="+92">Pakistan (+92)</option>
                            <option value="+95">Myanmar (+95)</option>
                            <option value="+66">Thailand (+66)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Phone Number (without country code)</label>
                        <input type="tel" id="phoneInputSimple" placeholder="17XXXXXXXX" required>
                    </div>

                    <div class="form-group">
                        <label>Display Name</label>
                        <input type="text" id="displayNameInput" placeholder="Your name" required>
                    </div>

                    <div class="form-group">
                        <label>Profile Picture (Optional)</label>
                        <div class="file-input">
                            <input type="file" id="profileUploadInput" accept="image/*">
                        </div>
                    </div>

                    <div class="login-actions">
                        <button type="submit" class="btn" id="doLogin">
                            <i class="fas fa-sign-in-alt"></i>
                            Login / Register
                        </button>
                        <button type="button" class="btn btn-secondary" id="clearLocal">
                            Clear Data
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="container hidden" id="appContainer">
        <div class="left-panel" id="leftPanel">
            <div class="header">
                <div class="profile-mini">
                    <img id="miniPic" src="https://i.pravatar.cc/100" alt="Profile">
                    <div class="profile-info">
                        <h3 id="miniName">Guest</h3>
                        <p id="miniNumber">Not logged in</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn-icon" id="themeBtn" title="Toggle theme">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="btn-icon" id="logoutBtn" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>

            <div class="search-box">
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Search chats...">
                </div>
            </div>

            <div class="new-chat-btn">
                <button class="btn" id="openNewChatPanel" style="width: 100%;">
                    <i class="fas fa-plus"></i>
                    Start New Chat
                </button>
            </div>

            <div class="chat-list" id="chatList">
                <div class="chat-item">
                    <div class="chat-avatar skeleton" style="width: 52px; height: 52px;"></div>
                    <div class="chat-content" style="flex: 1;">
                        <div class="skeleton" style="height: 16px; width: 60%; margin-bottom: 8px;"></div>
                        <div class="skeleton" style="height: 14px; width: 80%;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <button class="mobile-menu-btn btn-icon" id="mobileMenuBtn" style="display: none;">
                <i class="fas fa-bars"></i>
            </button>
            
            <div class="welcome-screen" id="welcomeScreen">
                <div class="welcome-content">
                    <div class="welcome-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                    <h2>Welcome to Pro Messenger</h2>
                    <p>Select a chat from the list to start messaging or create a new conversation.</p>
                    <button class="btn" id="welcomeNewChat">
                        <i class="fas fa-plus"></i>
                        Start New Chat
                    </button>
                </div>
            </div>

            <div class="chat-window hidden" id="chatWindow">
                <div class="chat-header-main">
                    <button class="back-to-chats btn-icon" id="backToChats">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="chat-partner">
                        <img id="chatWithPic" src="https://i.pravatar.cc/80" alt="Contact">
                        <div class="partner-info">
                            <h3 id="chatWithName">Select chat</h3>
                            <p id="chatWithNumber">--</p>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="btn-icon" id="openChatSettings" title="Chat settings">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>

                <div class="messages-container" id="chatMessages">
                    </div>

                <div class="typing-indicator" id="typingIndicator"></div>

                <div class="message-composer">
                    <div class="composer-container">
                        <button class="btn-icon" id="emojiToggle">
                            <i class="far fa-smile"></i>
                        </button>
                        <input type="text" id="messageBox" placeholder="Type a message...">
                        <div class="composer-actions">
                            <button class="btn-icon" id="attachFile">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <button class="btn" id="sendBtn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                    <div class="emoji-picker hidden" id="emojiPicker">
                        <span class="emoji" onclick="pickEmoji('üòä')">üòä</span>
                        <span class="emoji" onclick="pickEmoji('üòÇ')">üòÇ</span>
                        <span class="emoji" onclick="pickEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
                        <span class="emoji" onclick="pickEmoji('üëç')">üëç</span>
                        <span class="emoji" onclick="pickEmoji('üéâ')">üéâ</span>
                        <span class="emoji" onclick="pickEmoji('üôè')">üôè</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal hidden" id="newChatModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Start New Chat</h3>
                <button class="close-btn" id="closeNewChatModal">&times;</button>
            </div>
            <form id="newChatForm">
                <div class="form-group">
                    <label>Contact Number (with country code)</label>
                    <input type="tel" id="newChatNumber" placeholder="+8801712345678" required>
                </div>

                <div class="form-group">
                    <label>Contact Name (optional)</label>
                    <input type="text" id="newChatName" placeholder="Friend's name">
                </div>

                <div class="form-group">
                    <label>Contact Picture (optional)</label>
                    <div class="file-input">
                        <input type="file" id="newChatPic" accept="image/*">
                    </div>
                </div>

                <div class="login-actions">
                    <button type="submit" class="btn" id="addContactBtn">
                        <i class="fas fa-user-plus"></i>
                        Add Contact
                    </button>
                    <button type="button" class="btn btn-secondary" id="cancelNewChat">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal hidden" id="chatSettingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Chat Options</h3>
                <button class="close-btn" id="closeChatSettingsModal">&times;</button>
            </div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <button class="btn btn-secondary" id="deleteChatBtn">
                    <i class="fas fa-trash"></i>
                    Delete Chat
                </button>
                <button class="btn btn-secondary" id="clearChatHistory">
                    <i class="fas fa-broom"></i>
                    Clear History
                </button>
            </div>
        </div>
    </div>

    <input type="file" id="imagePicker" accept="image/*" style="display: none;">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, push, set, onChildAdded, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // Firebase Configuration - REPLACE WITH YOUR OWN CONFIG
        // NOTE: Keeping the provided dummy config for continuity
        const firebaseConfig = {
            apiKey: "AIzaSyBubSXHDTAEMSpaywiCQAkTrOPz3tijtZ0",
            authDomain: "fir-849f2.firebaseapp.com",
            databaseURL: "https://fir-849f2-default-rtdb.firebaseio.com",
            projectId: "fir-849f2",
            storageBucket: "fir-849f2.appspot.com",
            messagingSenderId: "695376931417",
            appId: "1:695376931417:web:b108541a5a7b216cc31f48"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);

        // App State
        let currentUser = null;
        let currentName = null;
        let currentPic = null;
        let currentChatId = null;
        let currentChatOther = null;
        let chatListeners = {};
        let chatListRef = null; // Store reference for chat list listener

        // DOM Elements
        const DOM = {
            loginModal: document.getElementById('loginModal'),
            appContainer: document.getElementById('appContainer'),
            leftPanel: document.getElementById('leftPanel'),
            chatList: document.getElementById('chatList'),
            welcomeScreen: document.getElementById('welcomeScreen'),
            chatWindow: document.getElementById('chatWindow'),
            chatMessages: document.getElementById('chatMessages'),
            messageBox: document.getElementById('messageBox'),
            searchInput: document.getElementById('searchInput'),
            mobileMenuBtn: document.getElementById('mobileMenuBtn'),
        };

        // Utility Functions
        function uidFor(a, b) {
            return [a, b].sort().join('_');
        }

        function nowStr() {
            return new Date().toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', day: 'numeric', month: 'short' });
        }

        function showElement(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function hideElement(id) {
            document.getElementById(id).classList.add('hidden');
        }
        
        // --- AUTHENTICATION & UI MANAGEMENT ---

        function loadSavedUser() {
            const saved = localStorage.getItem('prochat_user');
            if (saved) {
                try {
                    const obj = JSON.parse(saved);
                    currentUser = obj.phone;
                    currentName = obj.name;
                    currentPic = obj.pic;
                    updateUIAuth();
                } catch (e) {
                    localStorage.removeItem('prochat_user');
                }
            }
        }

        function saveUser() {
            if (!currentUser) return;
            localStorage.setItem('prochat_user', JSON.stringify({
                phone: currentUser,
                name: currentName,
                pic: currentPic
            }));
        }

        function updateUIAuth() {
            if (currentUser) {
                // Show app, hide login
                DOM.loginModal.style.display = 'none';
                DOM.appContainer.classList.remove('hidden');
                
                // Update user info
                document.getElementById('miniPic').src = currentPic || 'https://i.pravatar.cc/100';
                document.getElementById('miniName').textContent = currentName || 'You';
                document.getElementById('miniNumber').textContent = currentUser;
                
                // Load chats
                renderChatList();
                
                // Show mobile menu button on start
                if (window.innerWidth <= 800) {
                     DOM.mobileMenuBtn.style.display = 'flex';
                }
                
            } else {
                DOM.loginModal.style.display = 'flex';
                DOM.appContainer.classList.add('hidden');
                DOM.mobileMenuBtn.style.display = 'none';
            }
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const country = document.getElementById('countrySelect').value;
            const phone = document.getElementById('phoneInputSimple').value.trim();
            const displayName = document.getElementById('displayNameInput').value.trim();
            
            if (!phone || !displayName) {
                alert('Please fill out all required fields.');
                return;
            }

            const phoneFull = country + phone.replace(/^0+/, '');
            
            // Disable button and add loading class
            const loginBtn = document.getElementById('doLogin');
            loginBtn.disabled = true;
            loginBtn.classList.add('loading');
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
            
            try {
                // Upload profile picture if selected
                const fileInput = document.getElementById('profileUploadInput');
                let profilePic = 'https://i.pravatar.cc/100';
                
                if (fileInput.files[0]) {
                    const file = fileInput.files[0];
                    const storageRef = sRef(storage, `profiles/${phoneFull}_${Date.now()}_${file.name}`);
                    const snapshot = await uploadBytes(storageRef, file);
                    profilePic = await getDownloadURL(snapshot.ref);
                }

                // Set current user
                currentUser = phoneFull;
                currentName = displayName;
                currentPic = profilePic;
                
                // Save to localStorage
                saveUser();
                
                // Ensure user exists in database (create/update profile)
                const userRef = ref(db, `users/${currentUser}`);
                await update(userRef, {
                    name: currentName,
                    pic: currentPic,
                    lastSeen: nowStr()
                });
                
                // Update UI
                updateUIAuth();
                
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed. Check console for details.');
            } finally {
                 // Re-enable button
                loginBtn.disabled = false;
                loginBtn.classList.remove('loading');
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login / Register';
            }
        });
        
        // --- CHAT LIST MANAGEMENT ---

        function renderChatList() {
            if (!currentUser) return;

            // Clear previous listener if exists
            if (chatListRef) {
                // remove(chatListRef); // Note: Firebase v9+ 'onValue' returns an unsubscribe function
            }
            
            DOM.chatList.innerHTML = ''; // Clear loading skeleton on initial load

            chatListRef = ref(db, `chatList/${currentUser}`);
            
            onValue(chatListRef, (snapshot) => {
                const chats = snapshot.val() || {};
                let chatArray = Object.entries(chats).map(([id, data]) => ({ id, ...data }));
                
                // Sort by time
                chatArray.sort((a, b) => (b.time || '').localeCompare(a.time || ''));
                
                DOM.chatList.innerHTML = ''; // Clear existing list
                
                // Filter by search
                const searchTerm = DOM.searchInput.value.toLowerCase();
                const filteredChats = chatArray.filter(chat => 
                    !searchTerm || 
                    (chat.name || '').toLowerCase().includes(searchTerm) ||
                    (chat.contact || '').includes(searchTerm)
                );
                
                if (filteredChats.length === 0) {
                    DOM.chatList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--muted);">No chats found</div>';
                    return;
                }
                
                filteredChats.forEach(chat => {
                    const chatItem = document.createElement('div');
                    chatItem.className = `chat-item ${chat.id === currentChatId ? 'active' : ''}`;
                    
                    const timeDisplay = chat.time ? chat.time.split(',')[0] : '';
                    
                    chatItem.innerHTML = `
                        <img class="chat-avatar" src="${chat.pic || 'https://i.pravatar.cc/100'}" alt="${chat.name || 'Contact'}">
                        <div class="chat-content">
                            <div class="chat-header">
                                <div class="chat-name">${chat.name || chat.contact}</div>
                                <div class="time">${timeDisplay}</div>
                            </div>
                            <div class="last-message">${chat.lastMessage || 'No messages yet'}</div>
                        </div>
                        ${chat.unread > 0 ? `<div class="unread-badge">${chat.unread}</div>` : ''}
                    `;
                    
                    chatItem.addEventListener('click', () => {
                        openChat(chat.id, chat.contact, chat.name, chat.pic);
                        // Also un-toggle left panel on mobile
                        if (window.innerWidth <= 800) {
                            DOM.leftPanel.classList.remove('active');
                        }
                    });
                    DOM.chatList.appendChild(chatItem);
                });
            });
        }
        
        // --- CHAT WINDOW MANAGEMENT ---

        function openChat(chatId, otherNumber, otherName, otherPic) {
            // Check if already open
            if (currentChatId === chatId) {
                // Ensure chat window is visible
                hideElement('welcomeScreen');
                showElement('chatWindow');
                return;
            }

            // Clean up previous listener if switching chat
            if (currentChatId && chatListeners[currentChatId]) {
                // The 'onChildAdded' listener returns a function to unsubscribe, but 
                // for simplicity in this demo, we'll keep adding. For a production app, 
                // you would need to store and call the unsubscribe function.
            }
            
            // Set new state
            currentChatId = chatId;
            currentChatOther = otherNumber;
            
            // Update active state in chat list (re-render or manually update)
            document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
            // Since renderChatList is listening, it will update the class automatically on unread change.
            
            // Update chat header
            document.getElementById('chatWithName').textContent = otherName || otherNumber;
            document.getElementById('chatWithNumber').textContent = otherNumber;
            document.getElementById('chatWithPic').src = otherPic || 'https://i.pravatar.cc/100';
            
            // Reset unread count
            if (currentUser) {
                update(ref(db, `chatList/${currentUser}/${chatId}`), { unread: 0 });
            }
            
            // Show chat window
            hideElement('welcomeScreen');
            showElement('chatWindow');
            
            // Clear previous messages
            DOM.chatMessages.innerHTML = '';
            
            // Listen for messages (Using onChildAdded for continuous update)
            const messagesRef = ref(db, `messages/${chatId}`);
            onChildAdded(messagesRef, (snapshot) => {
                const message = snapshot.val();
                renderMessage(snapshot.key, message);
                
                // Mark as seen if from other user
                if (message.from !== currentUser && !message.seen) {
                    update(ref(db, `messages/${chatId}/${snapshot.key}`), { seen: true });
                }
            });
            
            // Focus on message box
            DOM.messageBox.focus();
        }

        function renderMessage(key, message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.from === currentUser ? 'sent' : 'received'}`;
            
            // Check if name is available, otherwise use number, if a message is received
            const senderName = message.from === currentUser 
                ? 'You' 
                : (message.fromName || message.from);
            
            let messageHTML = '';
            
            // Only show name for received messages and if it's not the same as the chat partner's display name
            if (message.from !== currentUser && senderName !== document.getElementById('chatWithName').textContent) {
                messageHTML += `<div style="font-weight: 600; font-size: 13px; margin-bottom: 4px; color: ${message.from === currentUser ? 'white' : 'var(--accent)'};">${senderName}</div>`;
            }

            if (message.text) {
                messageHTML += `<div>${message.text}</div>`;
            }
            
            if (message.image) {
                messageHTML += `<img class="message-image" src="${message.image}" alt="Shared image" onclick="window.open('${message.image}', '_blank')">`;
            }
            
            const seenStatus = message.from === currentUser ? (message.seen ? '‚úì‚úì' : '‚úì') : '';
            
            messageHTML += `
                <div class="message-time">
                    ${message.time || ''} ${seenStatus}
                </div>
            `;
            
            messageDiv.innerHTML = messageHTML;
            DOM.chatMessages.appendChild(messageDiv);
            DOM.chatMessages.scrollTop = DOM.chatMessages.scrollHeight;
        }

        // --- SEND MESSAGE ---

        document.getElementById('sendBtn').addEventListener('click', sendMessage);
        DOM.messageBox.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent form submit or newline
                await sendMessage();
            }
        });

        async function sendMessage() {
            if (!currentUser || !currentChatOther || !currentChatId) {
                alert('Please select a chat first');
                return;
            }

            const messageText = DOM.messageBox.value.trim();
            const imageFile = document.getElementById('imagePicker').files[0];

            if (!messageText && !imageFile) return;

            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                let imageUrl = null;
                
                // Upload image if exists
                if (imageFile) {
                    const storageRef = sRef(storage, `chat_images/${currentChatId}_${Date.now()}_${imageFile.name}`);
                    const snapshot = await uploadBytes(storageRef, imageFile);
                    imageUrl = await getDownloadURL(snapshot.ref);
                }

                // Create message object
                const messageData = {
                    from: currentUser,
                    fromName: currentName,
                    fromPic: currentPic,
                    text: messageText,
                    image: imageUrl,
                    time: nowStr(),
                    seen: false
                };

                // Save message to database
                const messagesRef = ref(db, `messages/${currentChatId}`);
                const newMessageRef = push(messagesRef);
                await set(newMessageRef, messageData);

                // Update chat lists for both users
                const updates = {};
                const lastMessage = messageText || (imageUrl ? 'üì∑ Image' : 'Message sent');
                
                const otherName = document.getElementById('chatWithName').textContent;
                const otherPic = document.getElementById('chatWithPic').src;
                
                // Update sender's chat list
                updates[`chatList/${currentUser}/${currentChatId}`] = {
                    contact: currentChatOther,
                    name: otherName,
                    pic: otherPic,
                    lastMessage: lastMessage,
                    time: nowStr(),
                    unread: 0
                };

                // Update receiver's chat list (optimistically setting unread to 1)
                updates[`chatList/${currentChatOther}/${currentChatId}`] = {
                    contact: currentUser,
                    name: currentName,
                    pic: currentPic,
                    lastMessage: lastMessage,
                    time: nowStr(),
                    // Increment unread count. In a real app, you would use a transaction for reliable increment.
                    unread: 1 
                };

                await update(ref(db), updates);

                // Clear inputs
                DOM.messageBox.value = '';
                document.getElementById('imagePicker').value = '';
                document.getElementById('emojiPicker').classList.add('hidden'); // Hide emoji picker
                
            } catch (error) {
                console.error('Send message error:', error);
                alert('Failed to send message: ' + error.message);
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            }
        }

        // --- NEW CHAT & MODAL FUNCTIONALITY ---
        
        document.getElementById('welcomeNewChat').addEventListener('click', () => showElement('newChatModal'));
        document.getElementById('openNewChatPanel').addEventListener('click', () => showElement('newChatModal'));
        document.getElementById('closeNewChatModal').addEventListener('click', () => hideElement('newChatModal'));
        document.getElementById('cancelNewChat').addEventListener('click', () => hideElement('newChatModal'));
        document.getElementById('closeChatSettingsModal').addEventListener('click', () => hideElement('chatSettingsModal'));
        document.getElementById('openChatSettings').addEventListener('click', () => showElement('chatSettingsModal'));

        document.getElementById('newChatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const phoneNumber = document.getElementById('newChatNumber').value.trim();
            const contactName = document.getElementById('newChatName').value.trim() || phoneNumber;
            
            if (!phoneNumber) return alert('Please enter phone number');
            
            const addContactBtn = document.getElementById('addContactBtn');
            addContactBtn.disabled = true;
            addContactBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';

            try {
                let contactPic = 'https://i.pravatar.cc/100';
                const fileInput = document.getElementById('newChatPic');
                
                if (fileInput.files[0]) {
                    const file = fileInput.files[0];
                    const storageRef = sRef(storage, `contacts/${phoneNumber}_${Date.now()}_${file.name}`);
                    const snapshot = await uploadBytes(storageRef, file);
                    contactPic = await getDownloadURL(snapshot.ref);
                }

                const chatId = uidFor(currentUser, phoneNumber);
                
                // Add to sender's chat list
                await update(ref(db, `chatList/${currentUser}/${chatId}`), {
                    contact: phoneNumber,
                    name: contactName,
                    pic: contactPic,
                    lastMessage: 'New chat started',
                    time: nowStr(),
                    unread: 0
                });
                
                // Also add to receiver's chat list to ensure they see it
                await update(ref(db, `chatList/${phoneNumber}/${chatId}`), {
                    contact: currentUser,
                    name: currentName,
                    pic: currentPic,
                    lastMessage: 'New chat started',
                    time: nowStr(),
                    unread: 0
                });

                // Close modal and clear form
                hideElement('newChatModal');
                document.getElementById('newChatForm').reset();
                
                // Open the new chat
                openChat(chatId, phoneNumber, contactName, contactPic);
                
            } catch (error) {
                console.error('Add contact error:', error);
                alert('Failed to add contact: ' + error.message);
            } finally {
                addContactBtn.disabled = false;
                addContactBtn.innerHTML = '<i class="fas fa-user-plus"></i> Add Contact';
            }
        });

        // --- GLOBAL EVENT LISTENERS ---

        document.getElementById('clearLocal').addEventListener('click', () => {
            if (confirm('Clear all local data? This will log you out.')) {
                localStorage.clear();
                location.reload();
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            if (confirm('Are you sure you want to logout?')) {
                // Clear state
                currentUser = null;
                currentName = null;
                currentPic = null;
                localStorage.removeItem('prochat_user');
                location.reload();
            }
        });

        document.getElementById('themeBtn').addEventListener('click', () => {
            document.body.classList.toggle('dark');
            const icon = document.querySelector('#themeBtn i');
            icon.className = document.body.classList.contains('dark') ? 'fas fa-sun' : 'fas fa-moon';
        });
        
        // Mobile Navigation Toggle
        document.getElementById('mobileMenuBtn').addEventListener('click', () => {
            DOM.leftPanel.classList.toggle('active');
        });

        document.getElementById('backToChats').addEventListener('click', () => {
            // Hide chat, show welcome screen, and toggle left panel on mobile
            hideElement('chatWindow');
            showElement('welcomeScreen');
            currentChatId = null;
            currentChatOther = null;
            if (window.innerWidth <= 800) {
                DOM.leftPanel.classList.add('active'); // Go back to the chat list view
            }
        });

        document.getElementById('attachFile').addEventListener('click', () => {
            document.getElementById('imagePicker').click();
        });
        
        document.getElementById('emojiToggle').addEventListener('click', () => {
            document.getElementById('emojiPicker').classList.toggle('hidden');
        });

        window.pickEmoji = (emoji) => {
            DOM.messageBox.value += emoji;
            DOM.messageBox.focus();
        };

        // Modal Close Buttons
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            });
        });

        // Search functionality
        DOM.searchInput.addEventListener('input', renderChatList);

        // --- Initialize App ---
        loadSavedUser();
        
        // Hide mobile menu button if screen is large on load
        window.addEventListener('resize', () => {
            if (window.innerWidth > 800) {
                DOM.mobileMenuBtn.style.display = 'none';
                DOM.leftPanel.classList.remove('active'); // Ensure left panel is always visible on desktop
            } else if (currentUser) {
                DOM.mobileMenuBtn.style.display = 'flex';
            }
        });
    </script>
</body>
</html>
