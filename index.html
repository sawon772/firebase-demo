<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pro Messenger - Firebase + Google Drive</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #f2f4f8;
            --card: #fff;
            --text: #111;
            --muted: #666;
            --accent: #0b84ff;
            --accent-hover: #0066cc;
            --border: #e1e6ee;
            --hover: rgba(0,0,0,0.03);
            --shadow: 0 6px 18px rgba(3,10,18,0.06);
            --radius: 12px;
            --radius-sm: 8px;
        }

        body.dark {
            --bg: #0f1214;
            --card: #1b1f22;
            --text: #e7e9ec;
            --muted: #9aa0a6;
            --accent: #2a9df4;
            --accent-hover: #1a7dcc;
            --border: #2a2f34;
            --hover: rgba(255,255,255,0.05);
            --shadow: 0 6px 18px rgba(0,0,0,0.2);
        }

        * {
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            height: 100vh;
            padding: 0;
            overflow: hidden;
        }

        /* Left Panel - Chat List */
        .left-panel {
            width: 360px;
            background: var(--card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            z-index: 10;
        }

        .header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--card);
        }

        .profile-mini {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .profile-mini img {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent);
        }

        .profile-info h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .profile-info p {
            margin: 2px 0 0;
            font-size: 13px;
            color: var(--muted);
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s;
        }

        .btn:hover {
            background: var(--accent-hover);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-icon {
            padding: 10px;
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            color: var(--muted);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover {
            background: var(--hover);
            color: var(--text);
        }

        .search-box {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .search-container {
            position: relative;
        }

        .search-container i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--muted);
        }

        .search-container input {
            width: 100%;
            padding: 12px 12px 12px 40px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text);
            font-size: 14px;
            outline: none;
        }

        .new-chat-btn {
            margin: 12px 20px;
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 8px;
        }

        .chat-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

        .chat-item:hover {
            background: var(--hover);
        }

        .chat-item.active {
            background: var(--accent);
            color: white;
        }

        .chat-avatar {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        .chat-content {
            flex: 1;
            min-width: 0;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .chat-name {
            font-weight: 600;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .time {
            font-size: 12px;
            color: var(--muted);
        }

        .last-message {
            font-size: 13px;
            color: var(--muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .unread-badge {
            background: #ff4d6d;
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 12px;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }

        /* Right Panel - Chat Window */
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg);
            position: relative;
        }

        .chat-window {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header-main {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            background: var(--card);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-partner {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-partner img {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
        }

        .partner-info h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .partner-info p {
            margin: 2px 0 0;
            font-size: 13px;
            color: var(--muted);
        }

        .chat-actions {
            display: flex;
            gap: 8px;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            align-self: flex-end;
            background: var(--accent);
            color: white;
            border-bottom-right-radius: 6px;
        }

        .message.received {
            align-self: flex-start;
            background: var(--card);
            border: 1px solid var(--border);
            border-bottom-left-radius: 6px;
        }

        .message-image {
            max-width: 250px;
            border-radius: 12px;
            margin-top: 8px;
            cursor: pointer;
        }

        .message-time {
            font-size: 11px;
            margin-top: 4px;
            opacity: 0.8;
            text-align: right;
        }

        .typing-indicator {
            padding: 0 24px 12px;
            font-size: 13px;
            color: var(--muted);
            font-style: italic;
        }

        .message-composer {
            padding: 16px 24px;
            background: var(--card);
            border-top: 1px solid var(--border);
        }

        .composer-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .composer-container input {
            flex: 1;
            padding: 12px 16px;
            border-radius: 24px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text);
            font-size: 15px;
            outline: none;
        }

        .composer-actions {
            display: flex;
            gap: 8px;
        }

        .emoji-picker {
            display: flex;
            gap: 8px;
            padding: 8px 0;
        }

        .emoji {
            cursor: pointer;
            font-size: 20px;
            transition: transform 0.2s;
        }

        .emoji:hover {
            transform: scale(1.2);
        }

        /* Login Area */
        .login-area {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            padding: 20px;
        }

        .login-card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 32px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 440px;
            text-align: center;
        }

        .login-card h2 {
            margin: 0 0 8px;
            font-weight: 700;
        }

        .login-card p {
            color: var(--muted);
            margin-bottom: 24px;
        }

        .google-signin-btn {
            background: white;
            color: #333;
            border: 1px solid #dadce0;
            padding: 12px 24px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            transition: background 0.2s;
        }

        .google-signin-btn:hover {
            background: #f8f9fa;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card);
            border-radius: var(--radius);
            padding: 24px;
            width: 90%;
            max-width: 440px;
            box-shadow: var(--shadow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            margin: 0;
            flex: 1;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--muted);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: 100vh;
            }

            .left-panel {
                width: 100%;
                height: 100%;
                position: absolute;
                z-index: 20;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .left-panel.active {
                transform: translateX(0);
            }

            .right-panel {
                width: 100%;
            }

            .message {
                max-width: 85%;
            }

            .header {
                padding: 12px 16px;
            }

            .chat-header-main {
                padding: 12px 16px;
            }

            .messages-container {
                padding: 16px;
            }

            .message-composer {
                padding: 12px 16px;
            }

            .mobile-menu-btn {
                display: flex;
            }

            .back-to-chats {
                display: flex;
            }
        }

        @media (min-width: 769px) {
            .mobile-menu-btn,
            .back-to-chats {
                display: none;
            }
        }

        .mobile-menu-btn,
        .back-to-chats {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text);
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            text-align: center;
            padding: 40px;
        }

        .welcome-content {
            max-width: 400px;
        }

        .welcome-icon {
            font-size: 64px;
            color: var(--accent);
            margin-bottom: 20px;
        }

        .welcome-content h2 {
            margin: 0 0 12px;
            font-weight: 700;
        }

        .welcome-content p {
            color: var(--muted);
            margin-bottom: 24px;
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .visible {
            display: flex !important;
        }

        /* Backup Status */
        .backup-status {
            font-size: 12px;
            color: var(--muted);
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
        }

        .status-online {
            color: #00c853;
        }

        .status-offline {
            color: #ff4444;
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div class="modal active" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Welcome to Pro Messenger</h3>
            </div>
            <div class="login-card" style="box-shadow: none; padding: 0;">
                <div style="text-align: center; padding: 20px 0;">
                    <i class="fas fa-comments" style="font-size: 64px; color: var(--accent); margin-bottom: 20px;"></i>
                    <h2>Pro Messenger</h2>
                    <p style="color: var(--muted); margin-bottom: 30px;">Secure messaging with Google Drive backup</p>
                    
                    <button class="google-signin-btn" id="googleSignInBtn">
                        <i class="fab fa-google" style="color: #4285f4;"></i>
                        Continue with Google
                    </button>

                    <div style="margin-top: 20px; padding: 16px; background: var(--bg); border-radius: var(--radius-sm);">
                        <div class="backup-status">
                            <i class="fas fa-shield-alt" style="color: var(--accent);"></i>
                            <span>End-to-end encrypted ‚Ä¢ Google Drive backup</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div class="container hidden" id="appContainer">
        <!-- Left Panel - Chat List -->
        <div class="left-panel" id="leftPanel">
            <div class="header">
                <div class="profile-mini">
                    <img id="miniPic" src="https://i.pravatar.cc/100" alt="Profile">
                    <div class="profile-info">
                        <h3 id="miniName">Guest</h3>
                        <p id="miniEmail">Not signed in</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn-icon" id="themeBtn" title="Toggle theme">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="btn-icon" id="driveBackupBtn" title="Google Drive Backup">
                        <i class="fab fa-google-drive"></i>
                    </button>
                    <button class="btn-icon" id="logoutBtn" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>

            <div class="search-box">
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Search chats...">
                </div>
            </div>

            <div class="new-chat-btn">
                <button class="btn" id="openNewChatPanel" style="width: 100%;">
                    <i class="fas fa-plus"></i>
                    Start New Chat
                </button>
            </div>

            <!-- Backup Status -->
            <div style="padding: 0 20px 8px;">
                <div class="backup-status" id="backupStatus">
                    <i class="fas fa-circle status-offline"></i>
                    <span>Drive Backup: Not Connected</span>
                </div>
            </div>

            <div class="chat-list" id="chatList">
                <!-- Chat items will be loaded here -->
            </div>
        </div>

        <!-- Right Panel - Chat Window -->
        <div class="right-panel">
            <!-- Welcome Screen -->
            <div class="welcome-screen" id="welcomeScreen">
                <div class="welcome-content">
                    <div class="welcome-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                    <h2>Welcome to Pro Messenger</h2>
                    <p>Select a chat from the list to start messaging or create a new conversation.</p>
                    <button class="btn" id="welcomeNewChat">
                        <i class="fas fa-plus"></i>
                        Start New Chat
                    </button>
                </div>
            </div>

            <!-- Chat Window -->
            <div class="chat-window hidden" id="chatWindow">
                <div class="chat-header-main">
                    <button class="back-to-chats" id="backToChats">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="chat-partner">
                        <img id="chatWithPic" src="https://i.pravatar.cc/80" alt="Contact">
                        <div class="partner-info">
                            <h3 id="chatWithName">Select chat</h3>
                            <p id="chatWithEmail">--</p>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="btn-icon" id="openChatSettings" title="Chat settings">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>

                <div class="messages-container" id="chatMessages">
                    <!-- Messages will be loaded here -->
                </div>

                <div class="typing-indicator" id="typingIndicator"></div>

                <div class="message-composer">
                    <div class="composer-container">
                        <button class="btn-icon" id="emojiToggle">
                            <i class="far fa-smile"></i>
                        </button>
                        <input type="text" id="messageBox" placeholder="Select a chat to start messaging...">
                        <div class="composer-actions">
                            <button class="btn-icon" id="attachFile">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <button class="btn" id="sendBtn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                    <div class="emoji-picker hidden" id="emojiPicker">
                        <span class="emoji" onclick="pickEmoji('üòä')">üòä</span>
                        <span class="emoji" onclick="pickEmoji('üòÇ')">üòÇ</span>
                        <span class="emoji" onclick="pickEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
                        <span class="emoji" onclick="pickEmoji('üëç')">üëç</span>
                        <span class="emoji" onclick="pickEmoji('üéâ')">üéâ</span>
                        <span class="emoji" onclick="pickEmoji('üôè')">üôè</span>
                    </div>
                </div>
            </div>

            <!-- Mobile Menu Button -->
            <button class="mobile-menu-btn hidden" id="mobileMenuBtn">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </div>

    <!-- New Chat Modal -->
    <div class="modal" id="newChatModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Start New Chat</h3>
                <button class="close-btn" id="closeNewChatModal">&times;</button>
            </div>
            <form id="newChatForm">
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500;">Contact Email</label>
                    <input type="email" id="newChatEmail" placeholder="friend@example.com" required style="width: 100%; padding: 12px 16px; border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--bg); color: var(--text);">
                </div>

                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500;">Contact Name (optional)</label>
                    <input type="text" id="newChatName" placeholder="Friend's name" style="width: 100%; padding: 12px 16px; border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--bg); color: var(--text);">
                </div>

                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button type="submit" class="btn" style="flex: 1;">
                        <i class="fas fa-user-plus"></i>
                        Add Contact
                    </button>
                    <button type="button" class="btn btn-secondary" id="cancelNewChat" style="flex: 1;">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Drive Backup Modal -->
    <div class="modal" id="driveBackupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Google Drive Backup</h3>
                <button class="close-btn" id="closeDriveModal">&times;</button>
            </div>
            <div style="text-align: center; padding: 20px 0;">
                <i class="fab fa-google-drive" style="font-size: 48px; color: #4285f4; margin-bottom: 16px;"></i>
                <h4>Backup Your Media to Google Drive</h4>
                <p style="color: var(--muted); margin-bottom: 20px;">Securely backup all your chat media files</p>
                
                <div id="driveAuthSection">
                    <button class="btn" id="connectDriveBtn" style="width: 100%; margin-bottom: 12px;">
                        <i class="fab fa-google"></i>
                        Connect Google Drive
                    </button>
                    <p style="font-size: 12px; color: var(--muted);">15GB Free Storage ‚Ä¢ Secure Backup</p>
                </div>

                <div id="driveConnectedSection" class="hidden">
                    <div style="background: var(--bg); padding: 16px; border-radius: var(--radius-sm); margin-bottom: 16px;">
                        <i class="fas fa-check-circle" style="color: #00c853;"></i>
                        <span style="margin-left: 8px;">Connected to Google Drive</span>
                    </div>
                    <button class="btn btn-secondary" id="backupNowBtn" style="width: 100%; margin-bottom: 8px;">
                        <i class="fas fa-cloud-upload-alt"></i>
                        Backup Now
                    </button>
                    <button class="btn btn-secondary" id="disconnectDriveBtn" style="width: 100%;">
                        <i class="fas fa-unlink"></i>
                        Disconnect
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="imagePicker" accept="image/*" style="display: none;">

    <!-- Firebase & Google APIs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script>
        // Firebase Configuration - YOUR CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCq_iAIcRoB-SflH5SxO9Gsd9ANeeXmX0M",
            authDomain: "my-chatapp-new.firebaseapp.com",
            databaseURL: "https://my-chatapp-new-default-rtdb.firebaseio.com",
            projectId: "my-chatapp-new",
            storageBucket: "my-chatapp-new.firebasestorage.app",
            messagingSenderId: "924372087325",
            appId: "1:924372087325:web:04da23166f19168c3d0cf4"
        };

        // Google Drive Configuration - YOUR CREDENTIALS
        const GOOGLE_DRIVE_CONFIG = {
            clientId: "638179327149-3sfem8ubkrf2e7c34nd42tpef5odskk3.apps.googleusercontent.com",
            scope: "https://www.googleapis.com/auth/drive.file"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // App State
        let currentUser = null;
        let currentChatId = null;
        let currentChatOther = null;
        let chatListeners = {};
        let driveAccessToken = null;

        // Utility Functions
        function uidFor(a, b) {
            return [a, b].sort().join('_');
        }

        function nowStr() {
            return new Date().toLocaleString();
        }

        function showElement(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function hideElement(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function showModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function hideModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // Google Drive Functions
        function connectGoogleDrive() {
            if (typeof google === 'undefined') {
                alert('Google API not loaded yet. Please wait a moment and try again.');
                return;
            }

            try {
                const tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_DRIVE_CONFIG.clientId,
                    scope: GOOGLE_DRIVE_CONFIG.scope,
                    callback: (response) => {
                        if (response.access_token) {
                            driveAccessToken = response.access_token;
                            updateDriveStatus(true);
                            showElement('driveConnectedSection');
                            hideElement('driveAuthSection');
                            localStorage.setItem('drive_access_token', driveAccessToken);
                            alert('Google Drive connected successfully!');
                        }
                    }
                });
                tokenClient.requestAccessToken();
            } catch (error) {
                console.error('Google Drive connection error:', error);
                alert('Error connecting to Google Drive');
            }
        }

        async function uploadToGoogleDrive(file, fileName) {
            if (!driveAccessToken) {
                throw new Error('Google Drive not connected');
            }

            const metadata = {
                name: fileName || `chat_media_${Date.now()}_${file.name}`,
                mimeType: file.type
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);

            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${driveAccessToken}`
                },
                body: form
            });

            if (!response.ok) {
                throw new Error(`Drive upload failed: ${response.statusText}`);
            }

            const result = await response.json();
            return `https://drive.google.com/file/d/${result.id}/view`;
        }

        function updateDriveStatus(connected) {
            const statusElement = document.getElementById('backupStatus');
            if (connected) {
                statusElement.innerHTML = '<i class="fas fa-circle status-online"></i><span>Drive Backup: Connected</span>';
            } else {
                statusElement.innerHTML = '<i class="fas fa-circle status-offline"></i><span>Drive Backup: Not Connected</span>';
            }
        }

        // Firebase Authentication
        function initAuth() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    updateUIAfterAuth(user);
                } else {
                    showModal('loginModal');
                    hideElement('appContainer');
                }
            });
        }

        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.addScope('profile');
            provider.addScope('email');
            
            auth.signInWithPopup(provider)
                .then((result) => {
                    // Signed in successfully
                    console.log('Google sign-in successful:', result.user);
                })
                .catch((error) => {
                    console.error('Google sign-in error:', error);
                    alert('Sign-in failed: ' + error.message);
                });
        }

        function updateUIAfterAuth(user) {
            hideModal('loginModal');
            showElement('appContainer');
            
            document.getElementById('miniPic').src = user.photoURL || 'https://i.pravatar.cc/100';
            document.getElementById('miniName').textContent = user.displayName || 'User';
            document.getElementById('miniEmail').textContent = user.email;
            
            // Load saved Drive token
            const savedToken = localStorage.getItem('drive_access_token');
            if (savedToken) {
                driveAccessToken = savedToken;
                updateDriveStatus(true);
            }
            
            renderChatList();
        }

        // Chat Functions
        function renderChatList() {
            const chatListEl = document.getElementById('chatList');
            if (!currentUser) return;

            const chatListRef = db.ref(`chatList/${currentUser.uid}`);
            
            chatListRef.on('value', (snapshot) => {
                const chats = snapshot.val() || {};
                const chatArray = Object.entries(chats).map(([id, data]) => ({ id, ...data }));
                
                chatArray.sort((a, b) => (b.time || '').localeCompare(a.time || ''));
                
                chatListEl.innerHTML = '';
                
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const filteredChats = chatArray.filter(chat => 
                    !searchTerm || 
                    (chat.name || '').toLowerCase().includes(searchTerm) ||
                    (chat.email || '').includes(searchTerm)
                );
                
                if (filteredChats.length === 0) {
                    chatListEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--muted);">No chats found</div>';
                    return;
                }
                
                filteredChats.forEach(chat => {
                    const chatItem = document.createElement('div');
                    chatItem.className = 'chat-item';
                    if (chat.id === currentChatId) {
                        chatItem.classList.add('active');
                    }
                    
                    chatItem.innerHTML = `
                        <img class="chat-avatar" src="${chat.photoURL || 'https://i.pravatar.cc/100'}" alt="${chat.name}">
                        <div class="chat-content">
                            <div class="chat-header">
                                <div class="chat-name">${chat.name || chat.email}</div>
                                <div class="time">${chat.time ? chat.time.split(',')[0] : ''}</div>
                            </div>
                            <div class="last-message">${chat.lastMessage || 'No messages yet'}</div>
                        </div>
                        ${chat.unread > 0 ? `<div class="unread-badge">${chat.unread}</div>` : ''}
                    `;
                    
                    chatItem.addEventListener('click', () => openChat(chat.id, chat.email, chat.name, chat.photoURL));
                    chatListEl.appendChild(chatItem);
                });
            });
        }

        function openChat(chatId, otherEmail, otherName, otherPhoto) {
            currentChatId = chatId;
            currentChatOther = otherEmail;
            
            document.getElementById('chatWithName').textContent = otherName || otherEmail;
            document.getElementById('chatWithEmail').textContent = otherEmail;
            document.getElementById('chatWithPic').src = otherPhoto || 'https://i.pravatar.cc/100';
            
            // Reset unread count
            if (currentUser) {
                const userChatRef = db.ref(`chatList/${currentUser.uid}/${chatId}`);
                userChatRef.update({ unread: 0 });
            }
            
            hideElement('welcomeScreen');
            showElement('chatWindow');
            
            const messageBox = document.getElementById('messageBox');
            if (messageBox) {
                messageBox.disabled = false;
                messageBox.placeholder = 'Type a message...';
                messageBox.focus();
            }
            
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
            
            // Listen for messages
            if (chatListeners[chatId]) return;
            
            const messagesRef = db.ref(`messages/${chatId}`);
            messagesRef.on('child_added', (snapshot) => {
                const message = snapshot.val();
                renderMessage(snapshot.key, message);
                
                if (message.from !== currentUser.uid && !message.seen) {
                    db.ref(`messages/${chatId}/${snapshot.key}`).update({ seen: true });
                }
            });
            
            chatListeners[chatId] = true;
        }

        function renderMessage(key, message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.from === currentUser.uid ? 'sent' : 'received'}`;
            
            let messageHTML = `
                <div style="font-weight: 600; margin-bottom: 4px;">
                    ${message.from === currentUser.uid ? 'You' : (message.fromName || 'Unknown')}
                </div>
            `;
            
            if (message.text) {
                messageHTML += `<div>${message.text}</div>`;
            }
            
            if (message.image) {
                messageHTML += `<img class="message-image" src="${message.image}" alt="Shared image" onclick="window.open('${message.image}', '_blank')">`;
            }
            
            messageHTML += `
                <div class="message-time">
                    ${message.time || ''} ${message.seen ? '‚úì‚úì' : '‚úì'}
                </div>
            `;
            
            messageDiv.innerHTML = messageHTML;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendMessage() {
            const messageBox = document.getElementById('messageBox');
            const imagePicker = document.getElementById('imagePicker');
            
            if (!currentUser || !currentChatOther) {
                alert('Please select a chat first');
                return;
            }

            const messageText = messageBox?.value.trim() || '';
            const imageFile = imagePicker?.files[0];

            if (!messageText && !imageFile) {
                return;
            }

            const chatId = uidFor(currentUser.uid, currentChatOther);

            try {
                let imageUrl = null;
                
                if (imageFile) {
                    if (driveAccessToken) {
                        try {
                            imageUrl = await uploadToGoogleDrive(imageFile, `chat_${chatId}_${imageFile.name}`);
                        } catch (driveError) {
                            console.warn('Drive upload failed:', driveError);
                            alert('Image upload failed. Please try again.');
                            return;
                        }
                    } else {
                        alert('Please connect Google Drive first to send images.');
                        return;
                    }
                }

                const messageData = {
                    from: currentUser.uid,
                    fromName: currentUser.displayName || currentUser.email,
                    fromPhoto: currentUser.photoURL,
                    text: messageText,
                    image: imageUrl,
                    time: nowStr(),
                    seen: false,
                    timestamp: Date.now()
                };

                const messagesRef = db.ref(`messages/${chatId}`);
                const newMessageRef = messagesRef.push();
                await newMessageRef.set(messageData);

                // Update chat lists
                const lastMessage = messageText || (imageUrl ? 'üì∑ Image' : '');
                
                // Update current user's chat list
                await db.ref(`chatList/${currentUser.uid}/${chatId}`).update({
                    email: currentChatOther,
                    name: document.getElementById('chatWithName').textContent,
                    photoURL: document.getElementById('chatWithPic').src,
                    lastMessage: lastMessage,
                    time: nowStr(),
                    unread: 0
                });

                // Update other user's chat list (in real app, you'd need their UID)
                // For demo, we'll just update current user's side

                // Clear inputs
                if (messageBox) {
                    messageBox.value = '';
                    messageBox.focus();
                }
                if (imagePicker) {
                    imagePicker.value = '';
                }

            } catch (error) {
                console.error('Send message error:', error);
                alert('Failed to send message: ' + error.message);
            }
        }

        // Event Listeners
        function setupEventListeners() {
            // Google Sign-in
            document.getElementById('googleSignInBtn').addEventListener('click', signInWithGoogle);

            // Send message
            document.getElementById('sendBtn').addEventListener('click', sendMessage);
            document.getElementById('messageBox').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // New chat
            document.getElementById('welcomeNewChat').addEventListener('click', () => {
                showModal('newChatModal');
            });
            document.getElementById('openNewChatPanel').addEventListener('click', () => {
                showModal('newChatModal');
            });

            // New chat form
            document.getElementById('newChatForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const contactEmail = document.getElementById('newChatEmail').value.trim();
                const contactName = document.getElementById('newChatName').value.trim() || contactEmail;
                
                if (!contactEmail) {
                    alert('Please enter contact email');
                    return;
                }

                try {
                    const chatId = uidFor(currentUser.uid, contactEmail);
                    
                    await db.ref(`chatList/${currentUser.uid}/${chatId}`).set({
                        email: contactEmail,
                        name: contactName,
                        photoURL: 'https://i.pravatar.cc/100',
                        lastMessage: '',
                        time: nowStr(),
                        unread: 0
                    });

                    hideModal('newChatModal');
                    document.getElementById('newChatForm').reset();
                    
                    openChat(chatId, contactEmail, contactName, 'https://i.pravatar.cc/100');
                    
                } catch (error) {
                    console.error('Add contact error:', error);
                    alert('Failed to add contact: ' + error.message);
                }
            });

            // Google Drive
            document.getElementById('driveBackupBtn').addEventListener('click', () => {
                showModal('driveBackupModal');
            });
            document.getElementById('connectDriveBtn').addEventListener('click', connectGoogleDrive);
            document.getElementById('disconnectDriveBtn').addEventListener('click', () => {
                driveAccessToken = null;
                localStorage.removeItem('drive_access_token');
                updateDriveStatus(false);
                showElement('driveAuthSection');
                hideElement('driveConnectedSection');
            });

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', () => {
                if (confirm('Are you sure you want to logout?')) {
                    auth.signOut();
                }
            });

            // Theme toggle
            document.getElementById('themeBtn').addEventListener('click', () => {
                document.body.classList.toggle('dark');
                const icon = document.querySelector('#themeBtn i');
                if (document.body.classList.contains('dark')) {
                    icon.className = 'fas fa-sun';
                } else {
                    icon.className = 'fas fa-moon';
                }
            });

            // Back to chats
            document.getElementById('backToChats').addEventListener('click', () => {
                hideElement('chatWindow');
                showElement('welcomeScreen');
                currentChatId = null;
                currentChatOther = null;
            });

            // Mobile menu
            document.getElementById('mobileMenuBtn').addEventListener('click', () => {
                document.getElementById('leftPanel').classList.add('active');
            });

            // Attach file
            document.getElementById('attachFile').addEventListener('click', () => {
                document.getElementById('imagePicker').click();
            });

            // Emoji toggle
            document.getElementById('emojiToggle').addEventListener('click', () => {
                const emojiPicker = document.getElementById('emojiPicker');
                emojiPicker.classList.toggle('hidden');
            });

            // Modal close buttons
            document.getElementById('closeNewChatModal').addEventListener('click', () => {
                hideModal('newChatModal');
            });
            document.getElementById('cancelNewChat').addEventListener('click', () => {
                hideModal('newChatModal');
            });
            document.getElementById('closeDriveModal').addEventListener('click', () => {
                hideModal('driveBackupModal');
            });

            // Search
            document.getElementById('searchInput').addEventListener('input', renderChatList);
        }

        // Emoji Picker
        window.pickEmoji = (emoji) => {
            const messageBox = document.getElementById('messageBox');
            messageBox.value += emoji;
            messageBox.focus();
        };

        // Initialize App
        function initializeApp() {
            setupEventListeners();
            initAuth();
        }

        // Start the app
        initializeApp();
    </script>
</body>
</html>
