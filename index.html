<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro ID Card Print & Arrange Tool</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base Reset and Fonts */
        body {
            font-family: 'Poppins', sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
            background: #f0f2f5; /* Light grey background */
            color: #333;
        }

        /* Container & Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            color: #007bff;
            font-weight: 600;
            margin-top: 20px;
            margin-bottom: 25px;
        }

        h2 {
            font-weight: 400;
            color: #555;
        }

        /* Forms & Inputs */
        #loginForm, #registerForm {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            max-width: 450px;
            margin: 50px auto;
            transition: all 0.3s ease-in-out;
        }
        
        #loginForm input, #registerForm input, .main-controls input, .main-controls select {
            width: 100%;
            box-sizing: border-box; /* Fix for box-sizing issue */
            margin: 10px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        #loginForm input:focus, #registerForm input:focus, .main-controls input:focus, .main-controls select:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.2);
        }

        /* Buttons */
        .btn, #loginForm button, #registerForm button {
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Primary Button - Login, Draw, Download */
        .btn-primary, #loginForm button:first-of-type {
            background: #007bff;
            color: white;
            width: calc(100% - 16px);
            margin-top: 15px;
        }

        .btn-primary:hover, #loginForm button:first-of-type:hover {
            background: #0056b3;
        }

        /* Success Button - Register, Save */
        .btn-success, #registerForm button:first-of-type {
            background: #28a745;
            color: white;
            width: calc(100% - 16px);
            margin-top: 15px;
        }

        .btn-success:hover, #registerForm button:first-of-type:hover {
            background: #1e7e34;
        }
        
        /* Secondary Button - Back, View Cards */
        .btn-secondary, #registerForm button:last-of-type {
            background: #6c757d;
            color: white;
            width: calc(100% - 16px);
        }

        .btn-secondary:hover, #registerForm button:last-of-type:hover {
            background: #5a6268;
        }
        
        /* Danger Button - Logout, Delete */
        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* Info/Camera Button */
        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }


        /* User Info */
        .user-info {
            background: #e9f7ef;
            padding: 15px;
            margin: 20px auto;
            border-radius: 8px;
            max-width: 90%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            font-weight: 600;
        }
        
        .user-info button {
            margin-left: 20px;
        }

        /* Marquee Section */
        .marquee-section {
            background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);
            color: white;
            padding: 10px 0;
            margin: 0 0 30px 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .marquee {
            white-space: nowrap;
            animation: marquee 25s linear infinite;
        }

        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        .marquee span {
            font-size: 15px;
            padding: 0 30px;
        }

        /* Canvas and Card Controls */
        #a4canvas {
            width: 794px;
            height: 1123px;
            max-width: 100%;
            border: 2px solid #ccc;
            background: white;
            margin: 20px auto;
            display: block;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .main-controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin: 20px auto;
        }
        
        .input-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .input-group label {
            font-weight: 600;
            margin-top: 15px;
            margin-bottom: 5px;
            display: block;
            color: #555;
        }

        .file-upload-section {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .file-upload-section input[type="file"] {
            display: none;
        }

        .preview-img {
            width: 150px;
            height: 95px; /* Added height for better visual consistency */
            object-fit: contain;
            margin: 10px;
            border: 2px dashed #007bff;
            border-radius: 8px;
            background: #f8f9fa;
        }

        /* Camera/Crop Section */
        .camera-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px auto;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.05);
        }
        
        .camera-section h3 {
            color: #17a2b8;
        }

        /* Crop Area Styles (Enhanced) */
        .crop-area {
            position: relative;
            max-width: 90%;
            margin: 30px auto;
            border: 3px solid #007bff;
            display: none;
            box-shadow: 0 0 20px rgba(0, 123, 255, 0.5);
            border-radius: 5px;
            overflow: hidden;
        }

        .crop-box {
            border: 2px dashed #ff4757;
            background: rgba(255, 71, 87, 0.15);
        }

        .crop-corner {
            width: 15px;
            height: 15px;
            background: #ff4757;
        }

        /* Saved Cards List */
        #savedCardsList {
            margin: 30px auto;
            max-width: 90%;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .card-item {
            border: 1px solid #e0e0e0;
            margin: 10px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            text-align: left;
            transition: transform 0.2s;
        }
        
        .card-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        
        .card-item strong {
            color: #007bff;
        }

        /* Footer */
        .footer {
            background: #2c3e50;
            color: white;
            padding: 40px 20px;
            margin-top: 50px;
            border-top: 5px solid #3498db;
        }

        .footer-content h3 {
            color: #3498db;
            font-weight: 600;
        }

        .contact-info p {
            margin: 10px 0;
        }

        .contact-info a {
            color: #85c1e9;
        }

        .whatsapp-btn {
            background: #25D366;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: 600;
        }

        .whatsapp-btn:hover {
            background: #128C7E;
        }

        /* Utility Class */
        .hidden {
            display: none !important;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            #loginForm, #registerForm, #savedCardsList {
                max-width: 95%;
                margin: 20px auto;
                padding: 20px;
            }
            
            .btn, #loginForm button, #registerForm button {
                font-size: 15px;
                padding: 10px;
                width: calc(100% - 16px);
                margin: 5px 8px;
            }
            
            .input-group {
                flex-direction: column;
                gap: 5px;
            }
            
            .input-group input, .input-group select {
                width: 100%;
            }

            .file-upload-section {
                flex-direction: column;
                gap: 10px;
            }
            
            .preview-img {
                width: 90%;
                height: auto;
                margin: 5px auto;
            }

            .marquee {
                white-space: normal;
                animation: none;
                text-align: center;
            }
            .marquee span {
                display: block;
                padding: 5px 10px;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
</head>
<body>

    <div class="marquee-section">
        <div class="marquee">
            <span>üì¢ ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶æ‡¶®‡¶ø‡¶§ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞, ‡¶Ü‡¶∏‡¶∏‡¶æ‡¶≤‡¶æ‡¶Æ‡ßÅ ‡¶Ü‡¶≤‡¶æ‡¶á‡¶ï‡ßÅ‡¶Æ! ‡¶è‡¶á ‡¶ü‡ßÅ‡¶≤‡¶∏‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ñ‡ßÅ‡¶¨ ‡¶∏‡¶π‡¶ú‡ßá ‡¶è‡¶¨‡¶Ç ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡ßç‡¶Ø‡¶æ‡¶∂‡¶®‡¶æ‡¶≤ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶ï‡¶æ‡¶∞‡ßç‡¶°, ‡¶°‡ßç‡¶∞‡¶æ‡¶á‡¶≠‡¶ø‡¶Ç ‡¶≤‡¶æ‡¶á‡¶∏‡ßá‡¶®‡ßç‡¶∏, ‡¶¨‡¶æ ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶Ü‡¶á‡¶°‡¶ø ‡¶ï‡¶æ‡¶∞‡ßç‡¶° A4 ‡¶∏‡¶æ‡¶á‡¶ú‡ßá‡¶∞ ‡¶™‡ßá‡¶™‡¶æ‡¶∞‡ßá ‡¶™‡¶æ‡¶∞‡¶´‡ßá‡¶ï‡ßç‡¶ü‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶∞‡ßá‡¶û‡ßç‡¶ú ‡¶ï‡¶∞‡ßá ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ - ‡¶Ü‡¶™‡¶®‡¶ø ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶á‡¶Æ‡ßá‡¶ú ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ï‡¶æ‡¶ú ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶ü‡ßÅ‡¶≤‡¶∏ ‡¶ï‡¶∞‡ßá ‡¶¶‡¶ø‡¶¨‡ßá! ‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶‡•§</span>
        </div>
    </div>

    <div class="container">
        <div id="loginForm">
            <h2>üîê Login to ID Card Tool</h2>
            <input type="email" id="loginEmail" placeholder="Email" required>
            <input type="password" id="loginPassword" placeholder="Password" required>
            <button onclick="login()" class="btn-primary">Login</button>
            <button onclick="showRegister()" class="btn-success">Register</button>
            <p id="loginMessage"></p>
        </div>

        <div id="registerForm" class="hidden">
            <h2>üìù Register New Account</h2>
            <input type="text" id="registerName" placeholder="Full Name" required>
            <input type="email" id="registerEmail" placeholder="Email" required>
            <input type="password" id="registerPassword" placeholder="Password (min 6 characters)" required>
            <button onclick="register()" class="btn-success">Register</button>
            <button onclick="showLogin()" class="btn-secondary">Back to Login</button>
            <p id="registerMessage"></p>
        </div>

        <div id="mainApp" class="hidden">
            <div class="user-info">
                Welcome, <span id="userName">User</span>! 
                <button onclick="logout()" class="btn btn-danger">Logout</button>
            </div>

            <h1>ü™™ Pro ID Card Print & Arrange Tool</h1>

            <div class="camera-section">
                <h3>üì∏ Image/Capture Options</h3>
                <button class="btn btn-info" onclick="openCamera()">üì∏ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®</button>
                <button class="btn btn-info" onclick="uploadImage()">üìÅ ‡¶á‡¶Æ‡ßá‡¶ú ‡¶Ü‡¶™‡¶≤‡ßã‡¶°</button>
                <button class="btn btn-info" onclick="startCrop()">‚úÇÔ∏è ‡¶ï‡ßç‡¶∞‡¶™ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>

            <div class="crop-area" id="cropContainer">
                <img id="cropImage" class="crop-image" src="" alt="Image to Crop">
                <div class="crop-box" id="cropBox">
                    <div class="crop-corner top-left"></div>
                    <div class="crop-corner top-right"></div>
                    <div class="crop-corner bottom-left"></div>
                    <div class="crop-corner bottom-right"></div>
                </div>
            </div>
            <div id="cropButtons" class="hidden" style="margin: 10px;">
                <button class="btn btn-success" onclick="applyCrop()">‚úÖ ‡¶ï‡ßç‡¶∞‡¶™ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <button class="btn btn-danger" onclick="cancelCrop()">‚ùå ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>

            <div class="main-controls">
                <div class="file-upload-section">
                    <input type="file" id="file1" accept="image/*">
                    <input type="file" id="file2" accept="image/*">
                </div>
                
                <div class="preview-section">
                    <img id="preview1" class="preview-img" src="" alt="Front Preview">
                    <img id="preview2" class="preview-img" src="" alt="Back Preview">
                    <p style="margin-top: 5px; font-size: 14px; color: #777;">‚¨ÜÔ∏è Front & Back Image Previews ‚¨ÜÔ∏è</p>
                </div>

                <div class="input-group">
                    <div>
                        <label for="widthMM">Width (mm):</label>
                        <input type="number" id="widthMM" value="85" step="0.1">
                    </div>
                    <div>
                        <label for="heightMM">Height (mm):</label>
                        <input type="number" id="heightMM" value="54" step="0.1">
                    </div>
                    <div>
                        <label for="paperSize">Paper Size:</label>
                        <select id="paperSize">
                            <option value="A4">A4</option>
                            <option value="Letter">Letter</option>
                            <option value="Legal">Legal</option>
                        </select>
                    </div>
                    <div>
                        <label for="downloadType">Download as:</label>
                        <select id="downloadType">
                            <option value="PDF">PDF</option>
                            <option value="JPG">JPG</option>
                            <option value="PNG">PNG</option>
                        </select>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="drawCanvas()">Preview & Arrange</button>
                    <button class="btn btn-secondary" onclick="downloadOutput()">Download</button>
                    <button class="btn btn-secondary" onclick="printCanvas()">Print</button>
                    <button class="btn btn-secondary" onclick="shareCanvas()">Share</button>
                    <button class="btn btn-success" onclick="saveToFirestore()">Save to Cloud</button>
                    <button class="btn btn-info" onclick="viewMyCards()">My Saved Cards</button>
                </div>
            </div>

            <canvas id="a4canvas"></canvas>

            <div id="savedCardsList"></div>

            <footer class="footer">
                <div class="footer-content">
                    <h3>üÜò ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                    <div class="contact-info">
                        <p>üì± WhatsApp: <a href="https://wa.me/8801881385068" target="_blank">01881385068</a></p>
                        <p>‚è∞ ‡¶∏‡¶Æ‡ßü: ‡¶∏‡¶ï‡¶æ‡¶≤ ‡ßØ‡¶ü‡¶æ - ‡¶∞‡¶æ‡¶§ ‡ßß‡ß¶‡¶ü‡¶æ</p>
                        <p>üí¨ ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡ßü ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶Ü‡¶õ‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡¶æ‡¶∂‡ßá</p>
                    </div>
                    <div class="social-links">
                        <button class="whatsapp-btn" onclick="openWhatsApp()">
                            üìû WhatsApp ‡¶è ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡ßÅ‡¶®
                        </button>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB_jVIj6vnpjRowsysZg79oH3iPFEX40Ow",
            authDomain: "idcardtool.firebaseapp.com",
            projectId: "idcardtool",
            storageBucket: "idcardtool.firebasestorage.app",
            messagingSenderId: "542300187907",
            appId: "1:542300187907:web:227d6f48edc5ca110d0d36",
            measurementId: "G-9XP8EHP686"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Canvas Elements
        const canvas = document.getElementById("a4canvas");
        const ctx = canvas.getContext("2d");
        let img1 = null;
        let img2 = null;

        // UI Elements
        const loginForm = document.getElementById("loginForm");
        const registerForm = document.getElementById("registerForm");
        const mainApp = document.getElementById("mainApp");
        const loginMessage = document.getElementById("loginMessage");
        const registerMessage = document.getElementById("registerMessage");
        const userName = document.getElementById("userName");

        // Authentication Functions
        function showRegister() {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
        }

        function showLogin() {
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
        }

        function register() {
            const name = document.getElementById("registerName").value;
            const email = document.getElementById("registerEmail").value;
            const password = document.getElementById("registerPassword").value;

            if (password.length < 6) {
                registerMessage.textContent = "Password must be at least 6 characters";
                registerMessage.style.color = "red";
                return;
            }

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Save user name to Firestore
                    return db.collection('users').doc(userCredential.user.uid).set({
                        name: name,
                        email: email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .then(() => {
                    registerMessage.textContent = "Registration successful!";
                    registerMessage.style.color = "green";
                    setTimeout(() => {
                        showLogin();
                    }, 2000);
                })
                .catch((error) => {
                    registerMessage.textContent = "Error: " + error.message;
                    registerMessage.style.color = "red";
                });
        }

        function login() {
            const email = document.getElementById("loginEmail").value;
            const password = document.getElementById("loginPassword").value;

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Login successful
                    loginMessage.textContent = "Login successful!";
                    loginMessage.style.color = "green";
                    
                    // Get user data
                    return db.collection('users').doc(userCredential.user.uid).get();
                })
                .then((doc) => {
                    if (doc.exists) {
                        userName.textContent = doc.data().name;
                    }
                    showMainApp();
                })
                .catch((error) => {
                    loginMessage.textContent = "Error: " + error.message;
                    loginMessage.style.color = "red";
                });
        }

        function logout() {
            auth.signOut().then(() => {
                showLoginForm();
            });
        }

        function showMainApp() {
            loginForm.classList.add('hidden');
            registerForm.classList.add('hidden');
            mainApp.classList.remove('hidden');
        }

        function showLoginForm() {
            mainApp.classList.add('hidden');
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            
            // Clear forms
            document.getElementById("loginEmail").value = "";
            document.getElementById("loginPassword").value = "";
            document.getElementById("registerName").value = "";
            document.getElementById("registerEmail").value = "";
            document.getElementById("registerPassword").value = "";
            loginMessage.textContent = "";
            registerMessage.textContent = "";
        }

        // Check if user is already logged in
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in
                db.collection('users').doc(user.uid).get().then((doc) => {
                    if (doc.exists) {
                        userName.textContent = doc.data().name;
                    }
                    showMainApp();
                });
            } else {
                // User is signed out
                showLoginForm();
            }
        });

        // ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶ñ‡ßã‡¶≤‡¶æ
        function openCamera() {
            alert('‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞‡¶ü‡¶ø ‡¶ñ‡ßÅ‡¶¨ ‡¶∂‡ßÄ‡¶ò‡ßç‡¶∞‡¶á ‡¶Ü‡¶∏‡¶õ‡ßá! ‡¶è‡¶ñ‡¶® ‡¶á‡¶Æ‡ßá‡¶ú ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
        }

        // ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶á‡¶Æ‡ßá‡¶ú ‡¶Ü‡¶™‡¶≤‡ßã‡¶°
        function uploadImage() {
            document.getElementById('file1').click();
        }

        // ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶ï‡ßç‡¶∞‡¶™ ‡¶∂‡ßÅ‡¶∞‡ßÅ
        function startCrop() {
            const cropContainer = document.getElementById('cropContainer');
            const cropButtons = document.getElementById('cropButtons');
            
            if (document.getElementById('preview1').src) {
                document.getElementById('cropImage').src = document.getElementById('preview1').src;
                cropContainer.classList.remove('hidden');
                cropButtons.classList.remove('hidden');
                alert('‡¶ï‡ßç‡¶∞‡¶™ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®! ‡¶á‡¶Æ‡ßá‡¶ú‡ßá‡¶∞ ‡¶ï‡¶∞‡ßç‡¶®‡¶æ‡¶∞ ‡¶ó‡ßÅ‡¶≤‡ßã ‡¶ü‡ßá‡¶®‡ßá ‡¶∏‡¶æ‡¶á‡¶ú adjust ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
            } else {
                alert('‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶á‡¶Æ‡ßá‡¶ú ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
            }
        }

        // ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶ï‡ßç‡¶∞‡¶™ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶≤‡¶æ‡¶á
        function applyCrop() {
            alert('‡¶ï‡ßç‡¶∞‡¶™ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‡¶è‡¶á ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞‡¶ü‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶≠‡¶æ‡¶∞‡ßç‡¶∏‡¶®‡ßá available ‡¶π‡¶¨‡ßá‡•§');
            document.getElementById('cropContainer').classList.add('hidden');
            document.getElementById('cropButtons').classList.add('hidden');
        }

        // ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶ï‡ßç‡¶∞‡¶™ ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤
        function cancelCrop() {
            document.getElementById('cropContainer').classList.add('hidden');
            document.getElementById('cropButtons').classList.add('hidden');
        }

        // ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: WhatsApp ‡¶ñ‡ßã‡¶≤‡¶æ
        function openWhatsApp() {
            window.open('https://wa.me/8801881385068', '_blank');
        }

        // Existing ID Card Tool Functions (Same as before)
        document.getElementById("file1").addEventListener("change", function(e){
            if(e.target.files[0]){
                const reader = new FileReader();
                reader.onload = () => document.getElementById("preview1").src = reader.result;
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        document.getElementById("file2").addEventListener("change", function(e){
            if(e.target.files[0]){
                const reader = new FileReader();
                reader.onload = () => document.getElementById("preview2").src = reader.result;
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        async function loadImage(file){
            return new Promise(resolve=>{
                const reader = new FileReader();
                reader.onload = ()=>{
                    const img = new Image();
                    img.onload = ()=>resolve(img);
                    img.src = reader.result;
                };
                reader.readAsDataURL(file);
            });
        }

        async function drawCanvas(){
            const file1 = document.getElementById("file1").files[0];
            const file2 = document.getElementById("file2").files[0];
            if(!file1 || !file2){
                alert("‡¶¶‡ßÅ‡¶á‡¶ü‡¶ø ‡¶´‡¶æ‡¶á‡¶≤ ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡¶ø‡¶®!");
                return;
            }
            img1 = await loadImage(file1);
            img2 = await loadImage(file2);
            
            const paper = document.getElementById("paperSize").value;
            switch(paper){
                case "A4": 
                    canvas.width=794;
                    canvas.height=1123;
                    break;
                case "Letter": 
                    canvas.width=816;
                    canvas.height=1056;
                    break;
                case "Legal": 
                    canvas.width=816;
                    canvas.height=1344;
                    break;
            }
            
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.fillStyle="white";
            ctx.fillRect(0,0,canvas.width,canvas.height);

            const cardWidth = parseFloat(document.getElementById("widthMM").value)*3.78;
            const cardHeight = parseFloat(document.getElementById("heightMM").value)*3.78;
            const gap = 90;
            const x = (canvas.width - cardWidth)/2;
            const y1 = (canvas.height - (cardHeight*2 + gap))/2;
            const y2 = y1 + cardHeight + gap;

            ctx.drawImage(img1,x,y1,cardWidth,cardHeight);
            ctx.drawImage(img2,x,y2,cardWidth,cardHeight);
            
            alert("‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá ‚úÖ");
        }

        function downloadOutput(){
            const type = document.getElementById("downloadType").value;
            if(type==="PDF"){
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF("p","pt",[canvas.width, canvas.height]);
                pdf.addImage(canvas.toDataURL("image/jpeg"),"JPEG",0,0,canvas.width,canvas.height);
                pdf.save("ID_Arranged.pdf");
            } else {
                const link = document.createElement("a");
                link.download = `ID_Arranged.${type.toLowerCase()}`;
                link.href = canvas.toDataURL(`image/${type.toLowerCase()}`);
                link.click();
            }
        }

        function printCanvas(){
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head><title>Print ID Card</title></head>
                    <body style="text-align: center;">
                        <img src="${canvas.toDataURL('image/png')}" style="max-width: 100%;">
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        async function shareCanvas(){
            canvas.toBlob(async function(blob){
                const filesArray = [new File([blob], "ID_A4.png", {type: "image/png"})];
                if(navigator.canShare && navigator.canShare({ files: filesArray })){
                    try{
                        await navigator.share({
                            files: filesArray,
                            title: 'ID Card A4',
                            text: 'Here is your arranged ID card!'
                        });
                        alert("Shared successfully ‚úÖ");
                    } catch(err){
                        alert("Share failed: " + err);
                    }
                } else {
                    alert("Your device/browser does not support direct file sharing!");
                }
            });
        }

        // Modified Firebase Functions to include user ID
        async function saveToFirestore() {
            const user = auth.currentUser;
            if (!user) {
                alert("Please login first!");
                return;
            }

            if (!canvas.width) {
                alert("‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá Preview ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®!");
                return;
            }

            const canvasDataURL = canvas.toDataURL('image/png');
            const cardId = 'card_' + Date.now();
            
            try {
                await db.collection('idcards').doc(cardId).set({
                    canvasImage: canvasDataURL,
                    image1: document.getElementById("preview1").src,
                    image2: document.getElementById("preview2").src,
                    width: document.getElementById("widthMM").value,
                    height: document.getElementById("heightMM").value,
                    paperSize: document.getElementById("paperSize").value,
                    userId: user.uid, // Store user ID
                    userName: userName.textContent,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert(`‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‚úÖ\n‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ID: ${cardId}`);
                
                const shareableLink = `${window.location.origin}${window.location.pathname}?id=${cardId}`;
                alert(`‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï:\n${shareableLink}`);
                
            } catch (error) {
                console.error("Error saving:", error);
                alert("‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            }
        }

        async function viewMyCards() {
            const user = auth.currentUser;
            if (!user) {
                alert("Please login first!");
                return;
            }

            try {
                const snapshot = await db.collection('idcards')
                    .where("userId", "==", user.uid) // Only show user's cards
                    .orderBy('createdAt', 'desc')
                    .limit(10)
                    .get();
                
                const cardsList = document.getElementById('savedCardsList');
                cardsList.innerHTML = '<h3>My Saved Cards:</h3>';
                
                if (snapshot.empty) {
                    cardsList.innerHTML += '<p>No saved cards found.</p>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const cardElement = document.createElement('div');
                    cardElement.className = 'card-item';
                    
                    cardElement.innerHTML = `
                        <p><strong>ID:</strong> ${doc.id}</p>
                        <p><strong>Saved:</strong> ${data.createdAt?.toDate().toLocaleString() || 'Unknown'}</p>
                        <p><strong>Size:</strong> ${data.width}mm x ${data.height}mm</p>
                        <button class="btn btn-primary" onclick="loadCard('${doc.id}')">Load This Card</button>
                        <button class="btn btn-secondary" onclick="shareCard('${doc.id}')">Share</button>
                        <button class="btn btn-danger" onclick="deleteCard('${doc.id}')">Delete</button>
                    `;
                    
                    cardsList.appendChild(cardElement);
                });
                
            } catch (error) {
                console.error("Error loading cards:", error);
                alert("‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            }
        }

        async function loadCard(cardId) {
            try {
                const doc = await db.collection('idcards').doc(cardId).get();
                
                if (doc.exists) {
                    const data = doc.data();
                    
                    const img = new Image();
                    img.onload = function() {
                        const paper = data.paperSize;
                        switch(paper){
                            case "A4": 
                                canvas.width=794;
                                canvas.height=1123;
                                break;
                            case "Letter": 
                                canvas.width=816;
                                canvas.height=1056;
                                break;
                            case "Legal": 
                                canvas.width=816;
                                canvas.height=1344;
                                break;
                        }
                        
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        alert("‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡ßã‡¶° ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‚úÖ");
                    };
                    img.src = data.canvasImage;
                    
                } else {
                    alert("‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!");
                }
            } catch (error) {
                console.error("Error loading card:", error);
                alert("‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            }
        }

        function shareCard(cardId) {
            const shareableLink = `${window.location.origin}${window.location.pathname}?id=${cardId}`;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareableLink);
                alert("‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‚úÖ\n\n" + shareableLink);
            } else {
                alert("‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï:\n" + shareableLink);
            }
        }

        async function deleteCard(cardId) {
            if (confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶è‡¶á ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
                try {
                    await db.collection('idcards').doc(cardId).delete();
                    alert("‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‚úÖ");
                    viewMyCards();
                } catch (error) {
                    console.error("Error deleting:", error);
                    alert("‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
                }
            }
        }

        // Load card from URL when page loads
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const cardId = urlParams.get('id');
            
            if (cardId) {
                setTimeout(() => {
                    loadCard(cardId);
                }, 1000);
            }
        };
        
        // **Crop Functionality (Basic JS for drag/resize - as requested to keep existing logic)**
        const cropBox = document.getElementById('cropBox');
        const cropContainer = document.getElementById('cropContainer');
        let isDragging = false;
        let isResizing = false;
        let activeCorner = null;
        let startX, startY, startW, startH, startLeft, startTop;

        const corners = cropBox.querySelectorAll('.crop-corner');

        cropBox.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('crop-corner')) {
                isResizing = true;
                activeCorner = e.target.classList[1];
            } else {
                isDragging = true;
                cropBox.style.cursor = 'grabbing';
            }
            
            startX = e.clientX;
            startY = e.clientY;
            startW = cropBox.offsetWidth;
            startH = cropBox.offsetHeight;
            startLeft = cropBox.offsetLeft;
            startTop = cropBox.offsetTop;
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging && !isResizing) return;
            
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            const containerW = cropContainer.offsetWidth;
            const containerH = cropContainer.offsetHeight;

            if (isDragging) {
                // Dragging Logic
                let newLeft = startLeft + dx;
                let newTop = startTop + dy;

                newLeft = Math.max(0, Math.min(newLeft, containerW - startW));
                newTop = Math.max(0, Math.min(newTop, containerH - startH));

                cropBox.style.left = newLeft + 'px';
                cropBox.style.top = newTop + 'px';
            } else if (isResizing) {
                // Resizing Logic
                let newW = startW;
                let newH = startH;
                let newLeft = startLeft;
                let newTop = startTop;

                switch (activeCorner) {
                    case 'top-left':
                        newW = startW - dx;
                        newH = startH - dy;
                        newLeft = startLeft + dx;
                        newTop = startTop + dy;
                        break;
                    case 'top-right':
                        newW = startW + dx;
                        newH = startH - dy;
                        newTop = startTop + dy;
                        break;
                    case 'bottom-left':
                        newW = startW - dx;
                        newH = startH + dy;
                        newLeft = startLeft + dx;
                        break;
                    case 'bottom-right':
                        newW = startW + dx;
                        newH = startH + dy;
                        break;
                }

                // Boundary and minimum size checks
                newW = Math.max(50, newW);
                newH = Math.max(50, newH);
                
                // Ensure box stays within container during resize
                if (newLeft + newW > containerW) { newW = containerW - newLeft; }
                if (newTop + newH > containerH) { newH = containerH - newTop; }
                if (newLeft < 0) { newW += newLeft; newLeft = 0; }
                if (newTop < 0) { newH += newTop; newTop = 0; }

                cropBox.style.width = newW + 'px';
                cropBox.style.height = newH + 'px';
                cropBox.style.left = newLeft + 'px';
                cropBox.style.top = newTop + 'px';
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
            isResizing = false;
            activeCorner = null;
            cropBox.style.cursor = 'move';
        });

    </script>
</body>
</html>
