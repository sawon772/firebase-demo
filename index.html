<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Firebase Private Chat</title>
</head>
<body>
  <h2>ðŸ“± Phone Login</h2>

  <div id="loginBox">
    <input type="text" id="phoneNumber" placeholder="+8801XXXXXXXXX"><br><br>
    <div id="recaptcha-container"></div>
    <button onclick="sendOTP()">Send OTP</button>
  </div>

  <div id="verifyBox" style="display:none;">
    <input type="text" id="otpCode" placeholder="Enter OTP"><br><br>
    <button onclick="verifyOTP()">Verify</button>
  </div>

  <div id="chatBox" style="display:none;">
    <h3>Welcome! Chat System</h3>
    <p>Your Number: <span id="myNumber"></span></p>
    <input id="targetNumber" placeholder="Send to (+8801...)"><br><br>
    <div id="messages" style="border:1px solid #ccc; padding:10px; height:200px; overflow:auto;"></div><br>
    <input id="msgInput" placeholder="Type message">
    <button onclick="sendMessage()">Send</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getDatabase, ref, push, set, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBubSXHDTAEMSpaywiCQAkTrOPz3tijtZ0",
      authDomain: "fir-849f2.firebaseapp.com",
      databaseURL: "https://fir-849f2-default-rtdb.firebaseio.com",
      projectId: "fir-849f2",
      storageBucket: "fir-849f2.firebasestorage.app",
      messagingSenderId: "695376931417",
      appId: "1:695376931417:web:b108541a5a7b216cc31f48"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Recaptcha à¦¤à§ˆà¦°à¦¿
    window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
      'size': 'normal',
      'callback': (response) => {}
    });

    let confirmationResult;
    let currentUser = null;

    // OTP à¦ªà¦¾à¦ à¦¾à¦¨à§‹
    window.sendOTP = function() {
      const phoneNumber = document.getElementById("phoneNumber").value;
      signInWithPhoneNumber(auth, phoneNumber, window.recaptchaVerifier)
        .then(result => {
          confirmationResult = result;
          alert("OTP à¦ªà¦¾à¦ à¦¾à¦¨à§‹ à¦¹à§Ÿà§‡à¦›à§‡!");
          document.getElementById("loginBox").style.display = "none";
          document.getElementById("verifyBox").style.display = "block";
        })
        .catch(error => alert(error.message));
    }

    // OTP à¦¯à¦¾à¦šà¦¾à¦‡ à¦•à¦°à¦¾
    window.verifyOTP = function() {
      const code = document.getElementById("otpCode").value;
      confirmationResult.confirm(code)
        .then(result => {
          currentUser = result.user.phoneNumber;
          document.getElementById("verifyBox").style.display = "none";
          document.getElementById("chatBox").style.display = "block";
          document.getElementById("myNumber").innerText = currentUser;
          loadMessages();
        })
        .catch(error => alert("Wrong OTP!"));
    }

    // à¦®à§‡à¦¸à§‡à¦œ à¦ªà¦¾à¦ à¦¾à¦¨à§‹ (à¦¨à¦¿à¦œà§‡à¦° à¦¨à¦¾à¦®à§à¦¬à¦¾à¦° à¦…à¦¨à§à¦¯à¦¾à§Ÿà§€ à¦†à¦²à¦¾à¦¦à¦¾ à¦°à§à¦®à§‡)
    window.sendMessage = function() {
      const target = document.getElementById("targetNumber").value.trim();
      const message = document.getElementById("msgInput").value.trim();
      if (!target || !message) return alert("à¦¨à¦¾à¦®à§à¦¬à¦¾à¦° à¦“ à¦®à§‡à¦¸à§‡à¦œ à¦²à¦¿à¦–à§‹!");

      const chatId = makeChatId(currentUser, target);
      const messagesRef = ref(db, `chats/${chatId}`);
      const newMsgRef = push(messagesRef);

      set(newMsgRef, {
        from: currentUser,
        to: target,
        text: message,
        time: new Date().toLocaleString()
      });

      document.getElementById("msgInput").value = '';
    }

    // à¦¦à§à¦‡ à¦¨à¦¾à¦®à§à¦¬à¦¾à¦° à¦®à¦¿à¦²à§‡ à¦à¦•à¦Ÿà¦¿à¦‡ à¦‡à¦‰à¦¨à¦¿à¦• à¦°à§à¦® à¦¤à§ˆà¦°à¦¿
    function makeChatId(num1, num2) {
      return [num1, num2].sort().join("_");
    }

    // à¦°à¦¿à§Ÿà§‡à¦²à¦Ÿà¦¾à¦‡à¦®à§‡ à¦®à§‡à¦¸à§‡à¦œ à¦¦à§‡à¦–à¦¾
    function loadMessages() {
      const targetInput = document.getElementById("targetNumber");
      targetInput.addEventListener("input", () => {
        const target = targetInput.value.trim();
        if (!target) return;
        const chatId = makeChatId(currentUser, target);
        const messagesRef = ref(db, `chats/${chatId}`);
        onValue(messagesRef, (snapshot) => {
          const data = snapshot.val();
          const box = document.getElementById("messages");
          box.innerHTML = '';
          if (data) {
            for (let key in data) {
              const msg = data[key];
              const p = document.createElement("p");
              p.textContent = `${msg.from === currentUser ? "You" : msg.from}: ${msg.text} (${msg.time})`;
              box.appendChild(p);
            }
          }
        });
      });
    }
  </script>
</body>
</html>
