<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Phone Chat App</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js"></script>
  <style>
    body { font-family: Arial; background:#f2f2f2; text-align:center; }
    #login,#chat{ width:90%; max-width:400px; margin:50px auto; background:white; padding:20px; border-radius:12px; box-shadow:0 0 10px rgba(0,0,0,0.1);}
    input{width:90%; padding:10px; margin:10px; border-radius:6px; border:1px solid #ccc;}
    button{padding:10px 20px; border:none; background:#007bff; color:white; border-radius:6px; cursor:pointer;}
    #messages{height:250px; overflow-y:auto; border:1px solid #ddd; margin:10px 0; padding:10px; text-align:left; border-radius:6px;}
    .msg{margin:5px 0; padding:8px; border-radius:6px;}
    .me{background:#d1e7ff; text-align:right;}
    .other{background:#f1f1f1; text-align:left;}
  </style>
</head>
<body>

<div id="login">
  <h2>üîí Phone Login</h2>
  <input type="text" id="phoneInput" placeholder="+8801712345678">
  <button onclick="login()">Login</button>
</div>

<div id="chat" style="display:none;">
  <h2>üí¨ Chat</h2>
  <p>Your Number: <span id="myNumber"></span></p>
  <input type="text" id="toNumber" placeholder="Enter number to chat">
  <div id="messages"></div>
  <input type="text" id="messageInput" placeholder="Type a message...">
  <button onclick="sendMessage()">Send</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, push, set, onChildAdded } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  // üîß ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ Firebase ‡¶ï‡¶®‡¶´‡¶ø‡¶ó (‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ URL ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá)
  const firebaseConfig = {
    apiKey: "AIzaSyBubSXHDTAEMSpaywiCQAkTrOPz3tijtZ0",
    authDomain: "fir-849f2.firebaseapp.com",
    databaseURL: "https://fir-849f2-default-rtdb.firebaseio.com/",
    projectId: "fir-849f2",
    storageBucket: "fir-849f2.appspot.com",
    messagingSenderId: "695376931417",
    appId: "1:695376931417:web:b108541a5a7b216cc31f48"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let currentUser = "";
  let chatWith = "";

  function login() {
    const phone = document.getElementById("phoneInput").value.trim();
    const bdFormat = /^\+8801[3-9]\d{8}$/;
    if (!bdFormat.test(phone)) return alert("‚ùå ‡¶≠‡ßÅ‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü! ‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£: +8801712345678");

    currentUser = phone;
    localStorage.setItem("currentUser", phone);
    document.getElementById("login").style.display = "none";
    document.getElementById("chat").style.display = "block";
    document.getElementById("myNumber").innerText = currentUser;
  }

  window.login = login;

  function sendMessage() {
    const msg = document.getElementById("messageInput").value.trim();
    const to = document.getElementById("toNumber").value.trim();
    if (!msg || !to) return alert("‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶ì ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ø‡¶ñ‡ßã!");
    chatWith = to;

    const chatId = currentUser < to ? currentUser + "_" + to : to + "_" + currentUser;
    const msgRef = push(ref(db, "messages/" + chatId));
    set(msgRef, {
      from: currentUser,
      text: msg,
      time: new Date().toLocaleString()
    });

    document.getElementById("messageInput").value = "";
  }

  window.sendMessage = sendMessage;

  function loadMessages() {
    const toInput = document.getElementById("toNumber");
    toInput.addEventListener("input", () => {
      document.getElementById("messages").innerHTML = "";
      const target = toInput.value.trim();
      if (!target) return;
      const chatId = currentUser < target ? currentUser + "_" + target : target + "_" + currentUser;
      const chatRef = ref(db, "messages/" + chatId);
      onChildAdded(chatRef, (data) => {
        const msg = data.val();
        const div = document.createElement("div");
        div.className = "msg " + (msg.from === currentUser ? "me" : "other");
        div.innerText = `${msg.from === currentUser ? "You" : msg.from}: ${msg.text}`;
        document.getElementById("messages").appendChild(div);
        const box = document.getElementById("messages");
        box.scrollTop = box.scrollHeight;
      });
    });
  }

  window.onload = () => {
    const savedUser = localStorage.getItem("currentUser");
    if (savedUser) {
      currentUser = savedUser;
      document.getElementById("login").style.display = "none";
      document.getElementById("chat").style.display = "block";
      document.getElementById("myNumber").innerText = currentUser;
    }
    loadMessages();
  };
</script>
</body>
</html>
